#!/usr/bin/python

# Copyright: (c) 2025, Calvin Remsburg (@cdot65) <dev@cdot.io>
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)

import json

from ansible.module_utils.basic import AnsibleModule
from scm.client import Scm as ScmClient
from scm.exceptions import APIError, ObjectNotPresentError
from scm.models.security import VulnerabilityProfileCreateModel

DOCUMENTATION = r"""
---
module: vulnerability_protection_profile
short_description: Manage Vulnerability Protection profiles in Strata Cloud Manager (SCM)
description:
    - Create, update, or delete Vulnerability Protection security profiles in Strata Cloud Manager using pan-scm-sdk.
    - Vulnerability Protection profiles define protection against known vulnerabilities.
    - Supports rules with CVE matching, threat exceptions, and packet capture.
version_added: "0.1.0"
author:
    - "Calvin Remsburg (@cdot65)"
options:
    name:
        description:
            - Name of the Vulnerability Protection profile.
            - Required for both state=present and state=absent.
        type: str
        required: false
    description:
        description:
            - Description of the Vulnerability Protection profile.
        type: str
        required: false
    rules:
        description:
            - List of vulnerability protection rules.
            - Each rule is a dictionary with rule attributes (name, severity, category, cve, host, etc.).
            - At least one rule is required when creating a profile.
        type: list
        elements: dict
        required: false
    threat_exception:
        description:
            - List of threat exceptions.
            - Each exception is a dictionary defining threat-specific overrides.
        type: list
        elements: dict
        required: false
    folder:
        description:
            - The folder in which the resource is defined.
            - Mutually exclusive with I(snippet) and I(device).
        type: str
        required: false
    snippet:
        description:
            - The snippet in which the resource is defined.
            - Mutually exclusive with I(folder) and I(device).
        type: str
        required: false
    device:
        description:
            - The device in which the resource is defined.
            - Mutually exclusive with I(folder) and I(snippet).
        type: str
        required: false
    id:
        description:
            - Unique identifier for the Vulnerability Protection profile (UUID).
            - Used for lookup/deletion if provided.
        type: str
        required: false
    scm_access_token:
        description:
            - Bearer access token for authenticating API calls, provided by the auth role.
        type: str
        required: true
    api_url:
        description:
            - The URL for the SCM API.
            - If not specified, the value of the SCM_API_URL environment variable will be used.
        type: str
        required: false
    state:
        description:
            - Desired state of the Vulnerability Protection profile.
        type: str
        choices: ['present', 'absent']
        default: present
notes:
    - Check mode is supported.
    - All operations are idempotent.
    - Uses pan-scm-sdk via unified client and bearer token from the auth role.
    - Exactly one container type (folder, snippet, or device) must be provided for state=present.
    - Rules structure is complex - see examples for proper formatting.
"""

EXAMPLES = r"""
- name: Create a basic Vulnerability Protection profile
  cdot65.scm.vulnerability_protection_profile:
    name: "Strict-Vulnerability-Protection"
    description: "Strict vulnerability protection profile"
    rules:
      - name: "block-critical-high-medium"
        severity:
          - "critical"
          - "high"
          - "medium"
        category: "any"
        cve:
          - "any"
        host: "any"
        vendor_id:
          - "any"
        threat_name: "any"
        packet_capture: "disable"
    folder: "Texas"
    scm_access_token: "{{ scm_access_token }}"
    state: present

- name: Create Vulnerability Protection profile with multiple rules
  cdot65.scm.vulnerability_protection_profile:
    name: "Balanced-Vulnerability-Protection"
    description: "Balanced vulnerability protection profile"
    rules:
      - name: "block-critical-high"
        severity:
          - "critical"
          - "high"
        category: "any"
        cve:
          - "any"
        host: "any"
        vendor_id:
          - "any"
        threat_name: "any"
        packet_capture: "single-packet"
        action:
          reset_both: {}
      - name: "alert-medium-low"
        severity:
          - "medium"
          - "low"
        category: "any"
        cve:
          - "any"
        host: "any"
        vendor_id:
          - "any"
        threat_name: "any"
        packet_capture: "disable"
        action:
          alert: {}
    folder: "Texas"
    scm_access_token: "{{ scm_access_token }}"
    state: present

- name: Create profile with CVE-specific rule
  cdot65.scm.vulnerability_protection_profile:
    name: "CVE-Specific-Profile"
    description: "Profile targeting specific CVEs"
    rules:
      - name: "block-log4shell"
        severity:
          - "critical"
        category: "code-execution"
        cve:
          - "CVE-2021-44228"
        host: "server"
        vendor_id:
          - "any"
        threat_name: "any"
        packet_capture: "extended-capture"
        action:
          block_ip:
            track_by: "source"
            duration: 3600
    folder: "Texas"
    scm_access_token: "{{ scm_access_token }}"
    state: present

- name: Delete Vulnerability Protection profile
  cdot65.scm.vulnerability_protection_profile:
    name: "Old-Profile"
    folder: "Texas"
    scm_access_token: "{{ scm_access_token }}"
    state: absent
"""

RETURN = r"""
changed:
    description: A boolean that indicates if a change was made.
    returned: always
    type: bool
msg:
    description: A message describing the change, if any.
    returned: always
    type: str
vulnerability_protection_profile:
    description: The created, updated, or deleted Vulnerability Protection profile.
    returned: when state=present
    type: dict
    sample:
        id: "123e4567-e89b-12d3-a456-426655440000"
        name: "Strict-Vulnerability-Protection"
        description: "Strict vulnerability protection profile"
        folder: "Texas"
        rules:
          - name: "block-critical-high-medium"
            severity:
              - "critical"
              - "high"
              - "medium"
            category: "any"
            cve:
              - "any"
            host: "any"
            vendor_id:
              - "any"
            threat_name: "any"
            packet_capture: "disable"
"""


def main():
    """Main module execution."""
    module_args = dict(
        name=dict(type="str", required=False),
        description=dict(type="str", required=False),
        rules=dict(type="list", elements="dict", required=False),
        threat_exception=dict(type="list", elements="dict", required=False),
        folder=dict(type="str", required=False),
        snippet=dict(type="str", required=False),
        device=dict(type="str", required=False),
        id=dict(type="str", required=False),
        scm_access_token=dict(type="str", required=True, no_log=True),
        api_url=dict(type="str", required=False),
        state=dict(type="str", choices=["present", "absent"], default="present"),
    )

    module = AnsibleModule(
        argument_spec=module_args,
        supports_check_mode=True,
        mutually_exclusive=[
            ["folder", "snippet", "device"],
        ],
    )

    result = {
        "changed": False,
        "msg": "",
        "vulnerability_protection_profile": {},
    }

    # Get module parameters
    params = module.params
    state = params["state"]
    scm_access_token = params["scm_access_token"]
    api_url = params.get("api_url") or "https://api.strata.paloaltonetworks.com"

    # Initialize the SCM client with bearer token
    try:
        client = ScmClient(access_token=scm_access_token, api_base_url=api_url)
    except Exception as e:
        module.fail_json(msg=f"Failed to initialize SCM client: {e!s}")

    # Determine container type and name
    container_type = None
    container_name = None
    for ctype in ["folder", "snippet", "device"]:
        if params.get(ctype):
            container_type = ctype
            container_name = params[ctype]
            break

    # Build the lookup parameters
    lookup_params = {}
    if container_type and container_name:
        lookup_params[container_type] = container_name

    # Check if profile exists
    existing_profile = None
    profile_id = params.get("id")
    profile_name = params.get("name")

    if profile_id:
        # Lookup by ID
        try:
            existing_profile = client.vulnerability_protection_profile.fetch(profile_id)
        except ObjectNotPresentError:
            existing_profile = None
        except APIError as e:
            module.fail_json(msg=f"Failed to fetch profile by ID: {e!s}")
    elif profile_name and container_type:
        # Lookup by name and container
        try:
            existing_profile = client.vulnerability_protection_profile.fetch(name=profile_name, **lookup_params)
        except ObjectNotPresentError:
            existing_profile = None
        except APIError as e:
            module.fail_json(msg=f"Failed to fetch profile by name: {e!s}")

    if state == "absent":
        if existing_profile:
            if not module.check_mode:
                try:
                    client.vulnerability_protection_profile.delete(str(existing_profile.id))
                    result["msg"] = f"Vulnerability Protection profile '{profile_name or profile_id}' deleted successfully"
                except APIError as e:
                    module.fail_json(msg=f"Failed to delete profile: {e!s}")
            else:
                result["msg"] = f"Would delete Vulnerability Protection profile '{profile_name or profile_id}'"
            result["changed"] = True
        else:
            result["msg"] = f"Vulnerability Protection profile '{profile_name or profile_id}' not found, nothing to delete"
        module.exit_json(**result)

    if not container_type:
        module.fail_json(msg="One of 'folder', 'snippet', or 'device' is required when state=present")

    if not profile_name:
        module.fail_json(msg="'name' is required when state=present")

    # Build the profile data
    profile_data = {
        "name": profile_name,
        container_type: container_name,
    }

    if params.get("description"):
        profile_data["description"] = params["description"]

    if params.get("rules"):
        profile_data["rules"] = params["rules"]
    elif not existing_profile:
        # Rules are required when creating a new profile
        module.fail_json(msg="'rules' parameter is required when creating a new Vulnerability Protection profile")

    if params.get("threat_exception"):
        profile_data["threat_exception"] = params["threat_exception"]

    # Validate and prepare the profile data using SDK models
    try:
        profile_model = VulnerabilityProfileCreateModel(**profile_data)
    except Exception as e:
        module.fail_json(msg=f"Failed to validate profile data: {e!s}")

    if existing_profile:
        # Check if update is needed
        needs_update = False
        update_fields = []

        # Compare name
        if existing_profile.name != profile_model.name:
            needs_update = True
            update_fields.append("name")

        # Compare description
        if getattr(existing_profile, "description", None) != profile_data.get("description"):
            needs_update = True
            update_fields.append("description")

        # Compare rules
        existing_rules = getattr(existing_profile, "rules", [])
        if existing_rules != profile_data.get("rules", []):
            needs_update = True
            update_fields.append("rules")

        # Compare threat_exception
        existing_exceptions = getattr(existing_profile, "threat_exception", [])
        if existing_exceptions != profile_data.get("threat_exception", []):
            needs_update = True
            update_fields.append("threat_exception")

        if needs_update:
            if not module.check_mode:
                try:
                    profile_data["id"] = str(existing_profile.id)
                    updated_profile = client.vulnerability_protection_profile.update(existing_profile)
                    result["vulnerability_protection_profile"] = json.loads(updated_profile.model_dump_json())
                    result["msg"] = f"Vulnerability Protection profile '{profile_name}' updated: {', '.join(update_fields)}"
                except APIError as e:
                    module.fail_json(msg=f"Failed to update profile: {e!s}")
            else:
                result["vulnerability_protection_profile"] = profile_data
                result["msg"] = f"Would update Vulnerability Protection profile '{profile_name}': {', '.join(update_fields)}"
            result["changed"] = True
        else:
            result["vulnerability_protection_profile"] = json.loads(existing_profile.model_dump_json())
            result["msg"] = f"Vulnerability Protection profile '{profile_name}' already exists with correct configuration"
    else:
        # Create new profile
        if not module.check_mode:
            try:
                created_profile = client.vulnerability_protection_profile.create(profile_data)
                result["vulnerability_protection_profile"] = json.loads(created_profile.model_dump_json())
                result["msg"] = f"Vulnerability Protection profile '{profile_name}' created successfully"
            except APIError as e:
                module.fail_json(msg=f"Failed to create profile: {e!s}")
        else:
            result["vulnerability_protection_profile"] = profile_data
            result["msg"] = f"Would create Vulnerability Protection profile '{profile_name}'"
        result["changed"] = True

    module.exit_json(**result)


if __name__ == "__main__":
    main()
