---
# Example playbook for managing bandwidth allocations in Strata Cloud Manager
# This demonstrates Create and Read operations for bandwidth allocation resources
#
# IMPORTANT LIMITATIONS:
# - The bandwidth allocation API has non-standard behavior
# - SPN names are auto-generated by the SCM platform (cannot be specified)
# - Update and Delete operations have API limitations in SCM v0.3.44
# - For updates/deletes, use the SCM UI or wait for API improvements

- name: Bandwidth Allocation Examples
  hosts: localhost
  gather_facts: false
  vars_files:
    - vault.yml

  tasks:
    # Setup authentication
    - name: Authenticate with SCM
      ansible.builtin.include_role:
        name: cdot65.scm.auth
      vars:
        client_id: "{{ scm_client_id }}"
        client_secret: "{{ scm_client_secret }}"
        tsg_id: "{{ scm_tsg_id }}"

    # Read: List existing allocations
    - name: List all bandwidth allocations
      cdot65.scm.bandwidth_allocation_info:
        scm_access_token: "{{ scm_access_token }}"
      register: all_allocations

    - name: Display existing allocations
      ansible.builtin.debug:
        msg: "Found {{ all_allocations.allocations | length }} existing bandwidth allocations"

    - name: Show allocation details
      ansible.builtin.debug:
        var: all_allocations.allocations

    # Create: Basic bandwidth allocation
    # Note: spn_name_list is auto-generated by the SCM platform
    - name: Create bandwidth allocation for test region
      cdot65.scm.bandwidth_allocation:
        name: "ansible-test-region"
        allocated_bandwidth: 1000.0
        scm_access_token: "{{ scm_access_token }}"
        state: present
      register: test_allocation

    - name: Display created allocation
      ansible.builtin.debug:
        var: test_allocation

    # Read: Get specific allocation
    - name: Get specific bandwidth allocation
      cdot65.scm.bandwidth_allocation_info:
        name: "ansible-test-region"
        scm_access_token: "{{ scm_access_token }}"
      register: specific_allocation

    - name: Display specific allocation
      ansible.builtin.debug:
        var: specific_allocation
